# VS2022 AI 辅助编程插件开发计划

## 项目信息

| 项目 | 说明 |
|------|------|
| **项目名称** | AI Coding Assistant for Visual Studio 2022 |
| **项目类型** | VSIX 插件 |
| **目标平台** | Visual Studio 2022 (17.x) |
| **开发语言** | C# (.NET 8) |
| **大模型** | Qwen3-Coder-480B-A35B-Instruct（私有化部署） |
| **网络要求** | 完全离线/内网运行，禁止外网连接 |

---

## 一、功能需求清单

### 1.1 核心功能

| 功能模块 | 描述 | 优先级 |
|----------|------|--------|
| **代码补全** | 智能上下文感知的实时代码补全 | P0 |
| **代码生成** | 自然语言描述转代码，支持多轮对话 | P0 |
| **项目理解** | 全项目代码索引与语义搜索 | P0 |
| **命令行操作** | 终端命令生成与执行 | P1 |
| **Agent 能力** | 自主任务规划与执行 | P0 |

### 1.2 Agent 能力详细需求

| 能力 | 描述 |
|------|------|
| **Tool Calling** | LLM 可调用工具执行操作（读写文件、搜索、运行命令） |
| **差异化编辑** | 精确修改代码片段，而非全量替换文件 |
| **智能上下文收集** | 自动收集相关代码、符号定义、项目结构 |
| **多步骤任务规划** | 自动分解复杂任务，逐步执行 |
| **并行工具调用** | 独立工具并行执行，提升效率 |
| **安全执行机制** | 命令分级（白名单/灰名单/黑名单） |
| **执行循环** | Agent Loop：决策 → 工具调用 → 结果反馈 → 继续决策 |

### 1.3 非功能需求

| 需求 | 说明 |
|------|------|
| **完全离线** | 所有功能不依赖外部网络 |
| **私有化部署** | 仅连接内网 LLM 服务 |
| **性能** | 代码补全响应 < 500ms |
| **安全** | 敏感操作需用户确认 |

---

## 二、技术架构

### 2.1 系统分层

```
┌─────────────────────────────────────────────────────────────────┐
│                        表现层 (UI)                               │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │
│  │ Inline补全  │ │ 对话窗口   │ │ 任务面板   │ │ 设置页面   │   │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │
├─────────────────────────────────────────────────────────────────┤
│                        Agent 层                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    AgentExecutor                           │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │ │
│  │  │ 任务规划  │ │ 工具分发  │ │ 上下文   │ │ 安全检查  │      │ │
│  │  │ Planner  │ │Dispatcher│ │ Manager  │ │  Guard   │      │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │ │
│  └────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                        工具层 (Tools)                            │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐       │
│  │ReadFile│ │  Edit  │ │ Search │ │RunCmd  │ │ Index  │       │
│  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘       │
├─────────────────────────────────────────────────────────────────┤
│                        基础设施层                                │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │
│  │ LLM Client │ │  Roslyn    │ │ 向量存储   │ │ 进程管理   │   │
│  │ (HTTP/SSE) │ │  分析器    │ │ (SQLite)   │ │            │   │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
                    ┌─────────────────────┐
                    │  内网 LLM 服务       │
                    │  Qwen3-Coder-480B   │
                    └─────────────────────┘
```

### 2.2 项目结构

```
src/
├── AIAssistant.Core/                    # 核心库
│   ├── Agent/
│   │   ├── AgentExecutor.cs            # Agent 执行器
│   │   ├── AgentPlanner.cs             # 任务规划器
│   │   └── AgentContext.cs             # Agent 上下文
│   ├── Tools/
│   │   ├── IAgentTool.cs               # 工具接口
│   │   ├── ToolDispatcher.cs           # 工具分发器
│   │   ├── ReadFileTool.cs             # 读文件工具
│   │   ├── EditFileTool.cs             # 编辑文件工具
│   │   ├── CodeSearchTool.cs           # 代码搜索工具
│   │   ├── GrepSearchTool.cs           # 文本搜索工具
│   │   ├── FindByNameTool.cs           # 文件名搜索工具
│   │   ├── WriteFileTool.cs            # 创建文件工具
│   │   ├── RunCommandTool.cs           # 命令执行工具
│   │   └── UpdatePlanTool.cs           # 计划管理工具
│   ├── LLM/
│   │   ├── ILLMClient.cs               # LLM 客户端接口
│   │   ├── LLMClient.cs                # LLM 客户端实现
│   │   ├── ToolCallingParser.cs        # 工具调用解析器
│   │   └── StreamingHandler.cs         # 流式响应处理
│   ├── Context/
│   │   ├── IContextManager.cs          # 上下文管理接口
│   │   ├── ContextManager.cs           # 上下文管理实现
│   │   ├── ContextWindow.cs            # 上下文窗口
│   │   └── TokenBudgetManager.cs       # Token 预算管理
│   ├── Indexing/
│   │   ├── CodeIndexer.cs              # 代码索引器
│   │   ├── VectorStore.cs              # 向量存储
│   │   ├── EmbeddingService.cs         # Embedding 服务
│   │   └── SemanticSearch.cs           # 语义搜索
│   ├── Security/
│   │   ├── SafetyGuard.cs              # 安全守卫
│   │   ├── CommandClassifier.cs        # 命令分类器
│   │   └── FileAccessPolicy.cs         # 文件访问策略
│   └── Prompt/
│       ├── PromptEngine.cs             # Prompt 引擎
│       ├── SystemPrompts.cs            # System Prompt 模板
│       └── ToolDescriptions.cs         # 工具描述
│
├── AIAssistant.VSIX/                    # VS 插件项目
│   ├── AIAssistantPackage.cs           # 插件入口
│   ├── source.extension.vsixmanifest   # 插件清单
│   ├── Completion/
│   │   ├── AICompletionSource.cs       # 代码补全源
│   │   └── InlineCompletionHandler.cs  # Inline 补全处理
│   ├── ToolWindows/
│   │   ├── ChatToolWindow.cs           # 对话窗口
│   │   ├── ChatToolWindowControl.xaml  # 对话界面
│   │   ├── ChatViewModel.cs            # 对话视图模型
│   │   ├── TaskPlanPanel.xaml          # 任务计划面板
│   │   └── ToolCallRenderer.cs         # 工具调用渲染
│   ├── Commands/
│   │   ├── OpenChatCommand.cs          # 打开对话命令
│   │   ├── ExplainCodeCommand.cs       # 解释代码命令
│   │   ├── GenerateTestCommand.cs      # 生成测试命令
│   │   └── QuickFixCommand.cs          # 快速修复命令
│   └── Settings/
│       ├── SettingsPage.cs             # 设置页面
│       └── PluginOptions.cs            # 插件选项
│
└── AIAssistant.Tests/                   # 单元测试
    ├── Agent/
    │   ├── AgentExecutorTests.cs
    │   └── ToolDispatcherTests.cs
    ├── Tools/
    │   ├── EditFileToolTests.cs
    │   └── CodeSearchToolTests.cs
    └── LLM/
        └── LLMClientTests.cs
```

---

## 三、开发阶段规划

### Phase 1: 基础框架 (Week 1-3)

**目标**: 搭建插件骨架和 LLM 通信能力

| 任务 | 描述 | 工时 |
|------|------|------|
| 1.1 创建 VSIX 项目 | 创建 VS2022 插件项目模板 | 2d |
| 1.2 LLM Client | 实现 HTTP 客户端，支持流式响应 | 3d |
| 1.3 Tool Calling 解析 | 解析 LLM 返回的工具调用 JSON | 2d |
| 1.4 基础 Tool Window | 创建对话窗口 UI 骨架 | 2d |
| 1.5 配置系统 | 实现 LLM 地址、API Key 等配置 | 1d |
| 1.6 日志系统 | 搭建调试日志基础设施 | 1d |

**交付物**:
- [x] 可加载的 VSIX 插件
- [x] 能够与内网 LLM 通信
- [x] 基础对话窗口

---

### Phase 2: Agent 核心 (Week 4-6)

**目标**: 实现 Agent 执行循环和核心工具

| 任务 | 描述 | 工时 |
|------|------|------|
| 2.1 AgentExecutor | 实现 Agent 执行循环 | 3d |
| 2.2 ToolDispatcher | 实现工具注册和分发机制 | 2d |
| 2.3 ReadFileTool | 读取文件工具 | 1d |
| 2.4 EditFileTool | 差异化编辑工具（核心） | 3d |
| 2.5 WriteFileTool | 创建新文件工具 | 1d |
| 2.6 安全检查 | 实现 SafetyGuard | 2d |
| 2.7 UI 集成 | 在对话窗口显示工具调用过程 | 3d |

**交付物**:
- [x] Agent 可执行多步骤任务
- [x] 可读取、编辑、创建文件
- [x] 危险操作需确认

---

### Phase 3: 代码搜索与项目理解 (Week 7-10)

**目标**: 实现代码索引和语义搜索

| 任务 | 描述 | 工时 |
|------|------|------|
| 3.1 Roslyn 分析器 | 使用 Roslyn 分析 C# 代码结构 | 4d |
| 3.2 代码块分割 | 按函数/类/文件分割代码 | 2d |
| 3.3 本地 Embedding | 集成 ONNX 模型生成向量 | 3d |
| 3.4 SQLite 向量存储 | 实现本地向量数据库 | 3d |
| 3.5 CodeSearchTool | 语义搜索工具 | 2d |
| 3.6 GrepSearchTool | 精确文本搜索工具 | 1d |
| 3.7 FindByNameTool | 文件名搜索工具 | 1d |
| 3.8 增量索引 | 文件变更时增量更新索引 | 2d |
| 3.9 上下文收集器 | 智能收集相关代码上下文 | 3d |

**交付物**:
- [x] 项目代码完成索引
- [x] 支持语义搜索
- [x] Agent 可理解整个项目

---

### Phase 4: 代码补全 (Week 11-13)

**目标**: 实现智能代码补全

| 任务 | 描述 | 工时 |
|------|------|------|
| 4.1 IAsyncCompletionSource | 实现 VS 补全提供者接口 | 3d |
| 4.2 上下文收集 | 收集光标周围代码上下文 | 2d |
| 4.3 FIM Prompt | 实现 Fill-in-the-Middle 格式 | 1d |
| 4.4 Inline 显示 | 灰色预览文本显示 | 3d |
| 4.5 Tab 接受 | Tab 键接受补全 | 1d |
| 4.6 部分接受 | 按词/按行部分接受 | 2d |
| 4.7 防抖优化 | 输入停止后才请求补全 | 1d |
| 4.8 缓存机制 | 相同上下文缓存结果 | 2d |

**交付物**:
- [x] 实时代码补全
- [x] 支持多行补全
- [x] 性能优化

---

### Phase 5: 代码生成与对话 (Week 14-16)

**目标**: 完善对话界面和代码生成

| 任务 | 描述 | 工时 |
|------|------|------|
| 5.1 对话界面完善 | 美化 UI，支持 Markdown 渲染 | 3d |
| 5.2 代码高亮 | 对话中代码块语法高亮 | 2d |
| 5.3 代码操作按钮 | [插入] [复制] [应用] 按钮 | 2d |
| 5.4 多轮对话 | 对话历史管理 | 2d |
| 5.5 任务计划面板 | 显示 Agent 执行计划 | 2d |
| 5.6 右键菜单 | 解释/重构/生成测试 | 2d |
| 5.7 快捷键 | 常用功能快捷键绑定 | 1d |
| 5.8 上下文选择 | 手动添加文件到上下文 | 2d |

**交付物**:
- [x] 完整对话体验
- [x] 代码可一键应用
- [x] 任务执行可视化

---

### Phase 6: 命令行操作 (Week 17-18)

**目标**: 实现终端命令能力

| 任务 | 描述 | 工时 |
|------|------|------|
| 6.1 RunCommandTool | 命令执行工具 | 2d |
| 6.2 进程管理 | 支持后台命令、取消命令 | 2d |
| 6.3 输出捕获 | 捕获 stdout/stderr | 1d |
| 6.4 命令分类 | 白名单/灰名单/黑名单分类 | 2d |
| 6.5 确认对话框 | 危险命令确认 UI | 1d |
| 6.6 结果分析 | AI 分析命令输出 | 2d |

**交付物**:
- [x] Agent 可执行命令
- [x] 命令安全分级
- [x] 输出结果可分析

---

### Phase 7: 优化与测试 (Week 19-22)

**目标**: 性能优化、全面测试、文档完善

| 任务 | 描述 | 工时 |
|------|------|------|
| 7.1 性能分析 | Profiling 识别瓶颈 | 3d |
| 7.2 并行工具调用 | 独立工具并行执行 | 2d |
| 7.3 Token 优化 | 减少上下文 Token 消耗 | 2d |
| 7.4 单元测试 | 核心模块测试覆盖 | 5d |
| 7.5 集成测试 | 端到端场景测试 | 3d |
| 7.6 用户文档 | 使用说明和快捷键指南 | 2d |
| 7.7 部署文档 | LLM 服务部署指南 | 2d |
| 7.8 Bug 修复 | 测试发现的问题修复 | 5d |

**交付物**:
- [x] 性能达标
- [x] 测试覆盖
- [x] 文档完整

---

## 四、里程碑总览

```
Week 1-3    Week 4-6    Week 7-10   Week 11-13  Week 14-16  Week 17-18  Week 19-22
   │           │           │           │           │           │           │
   ▼           ▼           ▼           ▼           ▼           ▼           ▼
┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐   ┌──────┐
│ M1   │   │ M2   │   │ M3   │   │ M4   │   │ M5   │   │ M6   │   │ M7   │
│基础  │──▶│Agent │──▶│搜索  │──▶│补全  │──▶│对话  │──▶│命令  │──▶│发布  │
│框架  │   │核心  │   │索引  │   │能力  │   │生成  │   │执行  │   │优化  │
└──────┘   └──────┘   └──────┘   └──────┘   └──────┘   └──────┘   └──────┘
```

| 里程碑 | 时间 | 关键交付 |
|--------|------|----------|
| **M1** | Week 3 | 插件可加载，LLM 通信正常 |
| **M2** | Week 6 | Agent 可执行文件操作 |
| **M3** | Week 10 | 项目索引完成，语义搜索可用 |
| **M4** | Week 13 | 代码补全功能可用 |
| **M5** | Week 16 | 完整对话和代码生成体验 |
| **M6** | Week 18 | 命令行能力完成 |
| **M7** | Week 22 | 发布就绪版本 |

---

## 五、核心工具清单

| 工具名 | 功能 | 安全级别 |
|--------|------|----------|
| `read_file` | 读取文件内容 | 安全 |
| `edit` | 精确编辑文件（查找替换） | 需确认 |
| `write_to_file` | 创建新文件 | 需确认 |
| `code_search` | 语义搜索代码 | 安全 |
| `grep_search` | 精确文本搜索 | 安全 |
| `find_by_name` | 文件名搜索 | 安全 |
| `run_command` | 执行终端命令 | 分级确认 |
| `update_plan` | 更新任务计划 | 安全 |
| `list_dir` | 列出目录内容 | 安全 |

---

## 六、技术依赖

### 6.1 开发依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| Visual Studio SDK | 17.x | 插件开发框架 |
| Microsoft.CodeAnalysis | 4.x | Roslyn 代码分析 |
| System.Text.Json | 8.x | JSON 序列化 |
| Microsoft.ML.OnnxRuntime | 1.x | 本地 Embedding 推理 |
| SQLite | 3.x | 本地向量存储 |
| CommunityToolkit.Mvvm | 8.x | MVVM 框架 |
| AvalonEdit | 6.x | 代码高亮显示 |

### 6.2 运行依赖

| 依赖 | 说明 |
|------|------|
| Visual Studio 2022 | 17.0 或更高版本 |
| .NET 8 Runtime | 运行时环境 |
| 内网 LLM 服务 | Qwen3-Coder-480B（vLLM 部署） |

---

## 七、风险与对策

| 风险 | 影响 | 对策 |
|------|------|------|
| LLM 响应延迟高 | 用户体验差 | 流式输出、请求缓存、防抖 |
| 大项目索引慢 | 首次加载久 | 增量索引、后台异步索引 |
| 差异化编辑匹配失败 | 代码修改失败 | 提供更多上下文、模糊匹配 |
| Token 超限 | 请求失败 | 上下文压缩、优先级裁剪 |
| 命令执行安全 | 误删文件 | 严格白名单、操作确认 |

---

## 八、验收标准

### 8.1 功能验收

- [ ] 代码补全在 500ms 内响应
- [ ] Agent 可完成"创建一个 REST API 控制器"任务
- [ ] 语义搜索可找到"用户认证相关代码"
- [ ] 差异化编辑可正确修改代码
- [ ] 命令执行有安全确认机制

### 8.2 性能验收

| 指标 | 目标 |
|------|------|
| 补全响应时间 | < 500ms |
| 大项目索引时间 | < 5min（首次） |
| 内存占用 | < 500MB |
| 文件编辑准确率 | > 95% |

### 8.3 安全验收

- [ ] 无外网请求
- [ ] 危险命令需确认
- [ ] 敏感配置加密存储
- [ ] 日志不记录完整代码

---

## 九、团队分工建议

| 角色 | 职责 | 人数 |
|------|------|------|
| **核心开发** | Agent、Tool、LLM Client | 2 |
| **VS 插件开发** | VSIX、UI、补全集成 | 1 |
| **索引/搜索** | Roslyn 分析、向量存储 | 1 |
| **测试** | 单元测试、集成测试 | 1 |
| **运维** | LLM 服务部署维护 | 1 |

---

**文档版本**: v1.0  
**创建日期**: 2026-02-04  
**最后更新**: 2026-02-04
