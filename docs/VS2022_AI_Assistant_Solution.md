# Visual Studio 2022 AI è¾…åŠ©ç¼–ç¨‹æ’ä»¶è§£å†³æ–¹æ¡ˆ

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®ç›®æ ‡
å¼€å‘ä¸€æ¬¾åŸºäº Visual Studio 2022 çš„ AI è¾…åŠ©ç¼–ç¨‹æ’ä»¶ï¼Œæä¾›ç±»ä¼¼ Cline/Cursor çš„æ™ºèƒ½ç¼–ç¨‹ä½“éªŒï¼Œæ‰€æœ‰åŠŸèƒ½å®Œå…¨ç¦»çº¿è¿è¡Œï¼Œè°ƒç”¨ç§æœ‰åŒ–éƒ¨ç½²çš„å¤§æ¨¡å‹æœåŠ¡ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§
- **ä»£ç è¡¥å…¨** - æ™ºèƒ½ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ä»£ç è‡ªåŠ¨è¡¥å…¨
- **ä»£ç ç”Ÿæˆ** - æ ¹æ®è‡ªç„¶è¯­è¨€æè¿°ç”Ÿæˆä»£ç 
- **é¡¹ç›®ç†è§£** - å…¨é¡¹ç›®ä»£ç ç´¢å¼•ä¸è¯­ä¹‰ç†è§£
- **å‘½ä»¤è¡Œæ“ä½œ** - é›†æˆç»ˆç«¯å‘½ä»¤æ‰§è¡Œèƒ½åŠ›
- **å®Œå…¨ç¦»çº¿** - æ‰€æœ‰åŠŸèƒ½ä¸ä¾èµ–å¤–éƒ¨ç½‘ç»œ

### 1.3 å¤§æ¨¡å‹é€‰å‹
- **æ¨¡å‹**: Qwen3-Coder-480B-A35B-Instruct
- **æ¥æº**: https://www.modelscope.cn/models/Qwen/Qwen3-Coder-480B-A35B-Instruct
- **éƒ¨ç½²æ–¹å¼**: ç§æœ‰åŒ–æœ¬åœ°/å†…ç½‘éƒ¨ç½²

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Visual Studio 2022                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   AI Assistant Plugin                    â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚ ä»£ç è¡¥å…¨  â”‚ â”‚ ä»£ç ç”Ÿæˆ  â”‚ â”‚ é¡¹ç›®ç†è§£  â”‚ â”‚ å‘½ä»¤æ‰§è¡Œ  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  Module  â”‚ â”‚  Module  â”‚ â”‚  Module  â”‚ â”‚  Module  â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚       â”‚            â”‚            â”‚            â”‚          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚              Core Service Layer                 â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Context â”‚ â”‚ Prompt  â”‚ â”‚   LLM Client    â”‚   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Manager â”‚ â”‚ Engine  â”‚ â”‚   (HTTP/gRPC)   â”‚   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚        Private Network (Intranet)         â”‚
                    â”‚                     â”‚                     â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚        LLM Inference Server          â”‚  â”‚
                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
                    â”‚  â”‚  â”‚   Qwen3-Coder-480B-A35B-Instruct â”‚ â”‚  â”‚
                    â”‚  â”‚  â”‚   (vLLM / TGI / Triton)         â”‚ â”‚  â”‚
                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¨¡å—è¯´æ˜

| æ¨¡å— | èŒè´£ | æŠ€æœ¯å®ç° |
|------|------|----------|
| **ä»£ç è¡¥å…¨æ¨¡å—** | å®æ—¶ä»£ç è¡¥å…¨å»ºè®® | VS Editor API + Completion Provider |
| **ä»£ç ç”Ÿæˆæ¨¡å—** | è‡ªç„¶è¯­è¨€åˆ°ä»£ç è½¬æ¢ | Tool Window + Chat Interface |
| **é¡¹ç›®ç†è§£æ¨¡å—** | ä»£ç ç´¢å¼•ã€è¯­ä¹‰æœç´¢ | Roslyn + å‘é‡æ•°æ®åº“ |
| **å‘½ä»¤æ‰§è¡Œæ¨¡å—** | ç»ˆç«¯å‘½ä»¤ç”Ÿæˆä¸æ‰§è¡Œ | Process API + Terminal Emulator |
| **æ ¸å¿ƒæœåŠ¡å±‚** | ä¸Šä¸‹æ–‡ç®¡ç†ã€Promptå·¥ç¨‹ã€LLMé€šä¿¡ | HTTP Client + æµå¼å“åº”å¤„ç† |

---

## 3. æŠ€æœ¯é€‰å‹

### 3.1 æ’ä»¶å¼€å‘æ¡†æ¶

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| **æ’ä»¶æ¡†æ¶** | VSIX (Visual Studio Extensibility) | VS2022 å®˜æ–¹æ‰©å±•å¼€å‘æ¡†æ¶ |
| **å¼€å‘è¯­è¨€** | C# (.NET 6/7/8) | VS æ’ä»¶æ ‡å‡†å¼€å‘è¯­è¨€ |
| **UI æ¡†æ¶** | WPF + MVVM | Tool Window å’Œå¯¹è¯ç•Œé¢ |
| **å¼‚æ­¥å¤„ç†** | async/await + Rx.NET | å¤„ç† LLM æµå¼å“åº” |

### 3.2 ä»£ç åˆ†æä¸ç´¢å¼•

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| **è¯­æ³•åˆ†æ** | Roslyn (Microsoft.CodeAnalysis) | C#/VB.NET ä»£ç åˆ†æ |
| **å¤šè¯­è¨€æ”¯æŒ** | Tree-sitter | æ”¯æŒå…¶ä»–ç¼–ç¨‹è¯­è¨€è§£æ |
| **å‘é‡æ•°æ®åº“** | SQLite + æœ¬åœ°å‘é‡ç´¢å¼• | ç¦»çº¿è¯­ä¹‰æœç´¢ |
| **Embedding** | æœ¬åœ° Embedding æ¨¡å‹ | text2vec æˆ–è½»é‡çº§æ¨¡å‹ |

### 3.3 LLM æ¨ç†æœåŠ¡

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|----------|------|
| **æ¨ç†æ¡†æ¶** | vLLM / Text Generation Inference | é«˜æ€§èƒ½æ¨ç†æœåŠ¡ |
| **API åè®®** | OpenAI Compatible API | æ ‡å‡†åŒ–æ¥å£ |
| **é€šä¿¡æ–¹å¼** | HTTP + SSE (Server-Sent Events) | æ”¯æŒæµå¼è¾“å‡º |

### 3.4 ç¡¬ä»¶éœ€æ±‚ï¼ˆå¤§æ¨¡å‹éƒ¨ç½²ï¼‰

```
Qwen3-Coder-480B-A35B-Instruct ç¡¬ä»¶éœ€æ±‚ä¼°ç®—ï¼š
â”œâ”€â”€ æ¨¡å‹è§„æ¨¡: 480B å‚æ•°ï¼Œæ¿€æ´»å‚æ•°çº¦ 35B (MoE æ¶æ„)
â”œâ”€â”€ æ˜¾å­˜éœ€æ±‚: 
â”‚   â”œâ”€â”€ FP16: çº¦ 960GB VRAM
â”‚   â”œâ”€â”€ INT8: çº¦ 480GB VRAM  
â”‚   â””â”€â”€ INT4: çº¦ 240GB VRAM
â”œâ”€â”€ æ¨èé…ç½®:
â”‚   â”œâ”€â”€ æ–¹æ¡ˆA: 8x NVIDIA A100 80GB (INT8)
â”‚   â”œâ”€â”€ æ–¹æ¡ˆB: 4x NVIDIA H100 80GB (INT4 + ä¼˜åŒ–)
â”‚   â””â”€â”€ æ–¹æ¡ˆC: å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼éƒ¨ç½²
â””â”€â”€ CPU/å†…å­˜: 256GB+ RAM, é«˜æ€§èƒ½ NVMe SSD
```

---

## 4. åŠŸèƒ½è¯¦ç»†è®¾è®¡

### 4.1 ä»£ç è¡¥å…¨ (Code Completion)

#### 4.1.1 åŠŸèƒ½æè¿°
- å®æ—¶åˆ†æå½“å‰å…‰æ ‡ä½ç½®çš„ä»£ç ä¸Šä¸‹æ–‡
- æä¾›æ™ºèƒ½ä»£ç è¡¥å…¨å»ºè®®ï¼ˆå•è¡Œ/å¤šè¡Œï¼‰
- æ”¯æŒ Tab é”®å¿«é€Ÿæ¥å—å»ºè®®
- æ”¯æŒéƒ¨åˆ†æ¥å—ï¼ˆæŒ‰è¯/æŒ‰è¡Œï¼‰

#### 4.1.2 æŠ€æœ¯å®ç°

```csharp
// æ ¸å¿ƒæ¥å£å®ç°
[Export(typeof(IAsyncCompletionSourceProvider))]
[ContentType("CSharp")]
[Name("AI Code Completion Provider")]
public class AICompletionSourceProvider : IAsyncCompletionSourceProvider
{
    public IAsyncCompletionSource GetOrCreate(ITextView textView)
    {
        return new AICompletionSource(textView, _llmClient, _contextManager);
    }
}

public class AICompletionSource : IAsyncCompletionSource
{
    public async Task<CompletionContext> GetCompletionContextAsync(
        IAsyncCompletionSession session,
        CompletionTrigger trigger,
        SnapshotPoint triggerLocation,
        SnapshotSpan applicableToSpan,
        CancellationToken token)
    {
        // 1. æ”¶é›†ä¸Šä¸‹æ–‡ï¼ˆå‰åæ–‡ä»£ç ã€æ–‡ä»¶ä¿¡æ¯ã€é¡¹ç›®ç»“æ„ï¼‰
        var context = await _contextManager.CollectContextAsync(triggerLocation);
        
        // 2. æ„å»º Prompt
        var prompt = _promptEngine.BuildCompletionPrompt(context);
        
        // 3. è°ƒç”¨ LLM è·å–è¡¥å…¨
        var completions = await _llmClient.GetCompletionsAsync(prompt, token);
        
        // 4. è¿”å›è¡¥å…¨é¡¹
        return new CompletionContext(completions.Select(ToCompletionItem));
    }
}
```

#### 4.1.3 ä¸Šä¸‹æ–‡æ”¶é›†ç­–ç•¥

```
ä¸Šä¸‹æ–‡çª—å£æ„å»º:
â”œâ”€â”€ å½“å‰æ–‡ä»¶
â”‚   â”œâ”€â”€ å…‰æ ‡å‰ N è¡Œä»£ç  (é»˜è®¤ 50 è¡Œ)
â”‚   â”œâ”€â”€ å…‰æ ‡å M è¡Œä»£ç  (é»˜è®¤ 20 è¡Œ)
â”‚   â””â”€â”€ æ–‡ä»¶å¤´éƒ¨ä¿¡æ¯ (imports, namespace)
â”œâ”€â”€ ç›¸å…³æ–‡ä»¶
â”‚   â”œâ”€â”€ åŒç›®å½•æ–‡ä»¶æ‘˜è¦
â”‚   â”œâ”€â”€ å¼•ç”¨çš„ç±»/æ¥å£å®šä¹‰
â”‚   â””â”€â”€ æœ€è¿‘ç¼–è¾‘çš„æ–‡ä»¶
â””â”€â”€ é¡¹ç›®ä¿¡æ¯
    â”œâ”€â”€ é¡¹ç›®ç±»å‹ (.csproj ä¿¡æ¯)
    â””â”€â”€ ä¾èµ–åŒ…åˆ—è¡¨
```

### 4.2 ä»£ç ç”Ÿæˆ (Code Generation)

#### 4.2.1 åŠŸèƒ½æè¿°
- è‡ªç„¶è¯­è¨€æè¿°è½¬ä»£ç 
- æ”¯æŒç”Ÿæˆå‡½æ•°ã€ç±»ã€æµ‹è¯•ç”¨ä¾‹
- æ”¯æŒä»£ç è§£é‡Šå’Œé‡æ„å»ºè®®
- æ”¯æŒå¤šè½®å¯¹è¯å¼ä»£ç ç”Ÿæˆ

#### 4.2.2 äº¤äº’ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Assistant                                    [_][â–¡][X]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [User] å¸®æˆ‘å†™ä¸€ä¸ªè¯»å– JSON é…ç½®æ–‡ä»¶çš„å·¥å…·ç±»         â”‚â”‚
â”‚  â”‚                                                     â”‚â”‚
â”‚  â”‚ [AI] å¥½çš„ï¼Œæˆ‘æ¥ä¸ºæ‚¨åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶è¯»å–å·¥å…·ç±»ï¼š     â”‚â”‚
â”‚  â”‚                                                     â”‚â”‚
â”‚  â”‚ ```csharp                                           â”‚â”‚
â”‚  â”‚ public class ConfigReader                           â”‚â”‚
â”‚  â”‚ {                                                   â”‚â”‚
â”‚  â”‚     public T Load<T>(string path) where T : class   â”‚â”‚
â”‚  â”‚     {                                               â”‚â”‚
â”‚  â”‚         var json = File.ReadAllText(path);          â”‚â”‚
â”‚  â”‚         return JsonSerializer.Deserialize<T>(json); â”‚â”‚
â”‚  â”‚     }                                               â”‚â”‚
â”‚  â”‚ }                                                   â”‚â”‚
â”‚  â”‚ ```                                                 â”‚â”‚
â”‚  â”‚ [æ’å…¥ä»£ç ] [å¤åˆ¶] [è§£é‡Š]                            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ è¯·è¾“å…¥æ‚¨çš„éœ€æ±‚...                          [å‘é€]   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  [ğŸ“ æ·»åŠ ä¸Šä¸‹æ–‡] [ğŸ”§ è®¾ç½®] [ğŸ“œ å†å²]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.3 åŠŸèƒ½èœå•

| åŠŸèƒ½ | å¿«æ·é”® | è¯´æ˜ |
|------|--------|------|
| æ‰“å¼€ AI åŠ©æ‰‹ | `Ctrl+Shift+A` | æ‰“å¼€å¯¹è¯çª—å£ |
| è§£é‡Šé€‰ä¸­ä»£ç  | `Ctrl+Shift+E` | è§£é‡Šå½“å‰é€‰ä¸­çš„ä»£ç  |
| ç”Ÿæˆæµ‹è¯• | `Ctrl+Shift+T` | ä¸ºé€‰ä¸­ä»£ç ç”Ÿæˆå•å…ƒæµ‹è¯• |
| é‡æ„å»ºè®® | `Ctrl+Shift+R` | è·å–ä»£ç é‡æ„å»ºè®® |
| ä¿®å¤é”™è¯¯ | `Ctrl+Shift+F` | åˆ†æå¹¶ä¿®å¤ä»£ç é”™è¯¯ |

### 4.3 é¡¹ç›®ç†è§£ (Project Understanding)

#### 4.3.1 åŠŸèƒ½æè¿°
- å…¨é¡¹ç›®ä»£ç ç´¢å¼•
- è¯­ä¹‰æœç´¢ï¼ˆæŒ‰åŠŸèƒ½/æ„å›¾æœç´¢ï¼‰
- ä»£ç å…³ç³»å›¾è°±
- æ™ºèƒ½é—®ç­”ï¼ˆå…³äºé¡¹ç›®çš„ä»»ä½•é—®é¢˜ï¼‰

#### 4.3.2 ç´¢å¼•æ¶æ„

```
é¡¹ç›®ç´¢å¼•æµç¨‹:
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  æºä»£ç æ–‡ä»¶   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼            â–¼            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ è¯­æ³•åˆ†æ  â”‚ â”‚ ç¬¦å·æå–  â”‚ â”‚ æ–‡æ¡£è§£æ  â”‚
        â”‚ (Roslyn) â”‚ â”‚          â”‚ â”‚          â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚            â”‚            â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  ä»£ç å—åˆ†å‰²   â”‚
                  â”‚ (å‡½æ•°/ç±»/æ–‡ä»¶) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼           â–¼           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Embedding â”‚ â”‚ å…ƒæ•°æ®   â”‚ â”‚ å…³ç³»å›¾   â”‚
        â”‚   ç”Ÿæˆ    â”‚ â”‚   å­˜å‚¨   â”‚ â”‚   æ„å»º   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
             â”‚            â”‚            â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  æœ¬åœ°å‘é‡åº“   â”‚
                  â”‚   (SQLite)   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.3 ç´¢å¼•æ•°æ®ç»“æ„

```csharp
public class CodeIndex
{
    public string Id { get; set; }                    // å”¯ä¸€æ ‡è¯†
    public string FilePath { get; set; }             // æ–‡ä»¶è·¯å¾„
    public string SymbolName { get; set; }           // ç¬¦å·åç§°
    public SymbolType Type { get; set; }             // ç±»å‹(ç±»/æ–¹æ³•/å±æ€§ç­‰)
    public string Content { get; set; }              // ä»£ç å†…å®¹
    public string Summary { get; set; }              // ä»£ç æ‘˜è¦
    public float[] Embedding { get; set; }           // å‘é‡è¡¨ç¤º
    public List<string> References { get; set; }     // å¼•ç”¨å…³ç³»
    public DateTime LastModified { get; set; }       // æœ€åä¿®æ”¹æ—¶é—´
}
```

### 4.4 å‘½ä»¤è¡Œæ“ä½œ (Terminal Operations)

#### 4.4.1 åŠŸèƒ½æè¿°
- è‡ªç„¶è¯­è¨€ç”Ÿæˆå‘½ä»¤è¡Œå‘½ä»¤
- å‘½ä»¤æ‰§è¡Œä¸ç»“æœåˆ†æ
- å‘½ä»¤æ‰§è¡Œå‰ç¡®è®¤æœºåˆ¶
- å‘½ä»¤æ‰§è¡Œå†å²è®°å½•

#### 4.4.2 å®‰å…¨æœºåˆ¶

```
å‘½ä»¤æ‰§è¡Œå®‰å…¨ç­–ç•¥:
â”œâ”€â”€ ç™½åå•å‘½ä»¤ (è‡ªåŠ¨æ‰§è¡Œ)
â”‚   â”œâ”€â”€ dotnet build
â”‚   â”œâ”€â”€ dotnet test
â”‚   â”œâ”€â”€ git status / git log
â”‚   â””â”€â”€ dir / ls / cat
â”œâ”€â”€ ç°åå•å‘½ä»¤ (éœ€ç¡®è®¤)
â”‚   â”œâ”€â”€ git commit / push
â”‚   â”œâ”€â”€ dotnet publish
â”‚   â””â”€â”€ npm install
â”œâ”€â”€ é»‘åå•å‘½ä»¤ (ç¦æ­¢æ‰§è¡Œ)
â”‚   â”œâ”€â”€ rm -rf / del /s
â”‚   â”œâ”€â”€ format
â”‚   â””â”€â”€ ç½‘ç»œç›¸å…³å‘½ä»¤ (ç¦æ­¢å¤–ç½‘è®¿é—®)
â””â”€â”€ è‡ªå®šä¹‰è§„åˆ™
    â””â”€â”€ ç”¨æˆ·å¯é…ç½®
```

#### 4.4.3 äº¤äº’æµç¨‹

```
ç”¨æˆ·: "ç¼–è¯‘å½“å‰é¡¹ç›®å¹¶è¿è¡Œæµ‹è¯•"
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI åˆ†æå¹¶ç”Ÿæˆå‘½ä»¤:                   â”‚
â”‚ 1. dotnet build                     â”‚
â”‚ 2. dotnet test                      â”‚
â”‚                                     â”‚
â”‚ [æ‰§è¡Œå…¨éƒ¨] [é€æ­¥æ‰§è¡Œ] [å–æ¶ˆ]         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼ (ç”¨æˆ·ç¡®è®¤)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œç»“æœ:                           â”‚
â”‚ > dotnet build                      â”‚
â”‚   Build succeeded. 0 Errors.        â”‚
â”‚ > dotnet test                       â”‚
â”‚   Total tests: 42                   â”‚
â”‚   Passed: 40, Failed: 2             â”‚
â”‚                                     â”‚
â”‚ AI: æœ‰ 2 ä¸ªæµ‹è¯•å¤±è´¥ï¼Œéœ€è¦å¸®æ‚¨åˆ†æå—ï¼Ÿ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. LLM é›†æˆæ–¹æ¡ˆ

### 5.1 æ¨¡å‹éƒ¨ç½²æ¶æ„

```
ç§æœ‰åŒ–éƒ¨ç½²æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼ä¸šå†…ç½‘ç¯å¢ƒ                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 æ¨ç†æœåŠ¡é›†ç¾¤                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚  GPU Node  â”‚  â”‚  GPU Node  â”‚  â”‚  GPU Node  â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  (A100x8)  â”‚  â”‚  (A100x8)  â”‚  â”‚  (A100x8)  â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚  â”‚
â”‚  â”‚                        â”‚                            â”‚  â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  â”‚
â”‚  â”‚            â”‚     Load Balancer     â”‚                â”‚  â”‚
â”‚  â”‚            â”‚    (Nginx/Traefik)    â”‚                â”‚  â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                API Gateway                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  - è®¤è¯æˆæƒ (API Key / Token)                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - è¯·æ±‚é™æµ                                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - æ—¥å¿—å®¡è®¡                                    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚           â”‚     VS2022 Client (æ’ä»¶)      â”‚                â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 API æ¥å£è§„èŒƒ

é‡‡ç”¨ OpenAI Compatible API æ ¼å¼ï¼Œä¾¿äºç»Ÿä¸€æ¥å£ï¼š

```http
POST /v1/chat/completions
Content-Type: application/json
Authorization: Bearer <API_KEY>

{
    "model": "qwen3-coder-480b",
    "messages": [
        {
            "role": "system",
            "content": "You are an expert coding assistant..."
        },
        {
            "role": "user",
            "content": "è¯·å¸®æˆ‘å®ç°ä¸€ä¸ªå¿«é€Ÿæ’åºç®—æ³•"
        }
    ],
    "temperature": 0.7,
    "max_tokens": 2048,
    "stream": true
}
```

### 5.3 LLM Client å®ç°

```csharp
public class LLMClient : ILLMClient
{
    private readonly HttpClient _httpClient;
    private readonly LLMSettings _settings;

    public async IAsyncEnumerable<string> StreamChatAsync(
        List<ChatMessage> messages,
        [EnumeratorCancellation] CancellationToken cancellationToken = default)
    {
        var request = new ChatCompletionRequest
        {
            Model = _settings.ModelName,
            Messages = messages,
            Stream = true,
            Temperature = _settings.Temperature,
            MaxTokens = _settings.MaxTokens
        };

        using var response = await _httpClient.PostAsJsonAsync(
            $"{_settings.BaseUrl}/v1/chat/completions",
            request,
            cancellationToken);

        await using var stream = await response.Content.ReadAsStreamAsync();
        using var reader = new StreamReader(stream);

        while (!reader.EndOfStream)
        {
            var line = await reader.ReadLineAsync();
            if (line?.StartsWith("data: ") == true)
            {
                var data = line[6..];
                if (data == "[DONE]") yield break;

                var chunk = JsonSerializer.Deserialize<ChatCompletionChunk>(data);
                var content = chunk?.Choices?.FirstOrDefault()?.Delta?.Content;
                if (!string.IsNullOrEmpty(content))
                {
                    yield return content;
                }
            }
        }
    }
}
```

### 5.4 Prompt å·¥ç¨‹

#### 5.4.1 System Prompt æ¨¡æ¿

```
# ä»£ç è¡¥å…¨ System Prompt
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç è¡¥å…¨åŠ©æ‰‹ã€‚æ ¹æ®ä¸Šä¸‹æ–‡æä¾›å‡†ç¡®ã€ç®€æ´çš„ä»£ç è¡¥å…¨å»ºè®®ã€‚

è§„åˆ™ï¼š
1. åªè¾“å‡ºéœ€è¦è¡¥å…¨çš„ä»£ç ï¼Œä¸è¦è§£é‡Š
2. éµå¾ªå½“å‰ä»£ç çš„é£æ ¼å’Œå‘½åè§„èŒƒ
3. è€ƒè™‘é¡¹ç›®çš„ä¾èµ–å’Œå¯¼å…¥
4. ç”Ÿæˆçš„ä»£ç å¿…é¡»è¯­æ³•æ­£ç¡®

# ä»£ç ç”Ÿæˆ System Prompt
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶å¼€å‘åŠ©æ‰‹ï¼Œæ“…é•¿ï¼š
- æ ¹æ®éœ€æ±‚ç”Ÿæˆé«˜è´¨é‡ä»£ç 
- è§£é‡Šå’Œåˆ†æä»£ç 
- æä¾›é‡æ„å’Œä¼˜åŒ–å»ºè®®
- ç¼–å†™å•å…ƒæµ‹è¯•

è§„åˆ™ï¼š
1. ä»£ç è¦æœ‰æ¸…æ™°çš„ç»“æ„å’Œæ³¨é‡Š
2. éµå¾ªæœ€ä½³å®è·µå’Œè®¾è®¡æ¨¡å¼
3. è€ƒè™‘è¾¹ç•Œæ¡ä»¶å’Œé”™è¯¯å¤„ç†
4. ä½¿ç”¨é¡¹ç›®ä¸­å·²æœ‰çš„å·¥å…·ç±»å’Œåº“
```

#### 5.4.2 Fill-in-the-Middle (FIM) æ ¼å¼

```
<|fim_prefix|>{å…‰æ ‡å‰çš„ä»£ç }
<|fim_suffix|>{å…‰æ ‡åçš„ä»£ç }
<|fim_middle|>
```

---

## 6. é¡¹ç›®ç»“æ„

```
AIConsProject/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ AIAssistant.Core/                    # æ ¸å¿ƒåº“
â”‚   â”‚   â”œâ”€â”€ LLM/
â”‚   â”‚   â”‚   â”œâ”€â”€ ILLMClient.cs               # LLM å®¢æˆ·ç«¯æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ LLMClient.cs                # LLM å®¢æˆ·ç«¯å®ç°
â”‚   â”‚   â”‚   â”œâ”€â”€ LLMSettings.cs              # é…ç½®ç±»
â”‚   â”‚   â”‚   â””â”€â”€ Models/                      # è¯·æ±‚/å“åº”æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Context/
â”‚   â”‚   â”‚   â”œâ”€â”€ IContextManager.cs          # ä¸Šä¸‹æ–‡ç®¡ç†æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ ContextManager.cs           # ä¸Šä¸‹æ–‡ç®¡ç†å®ç°
â”‚   â”‚   â”‚   â””â”€â”€ ContextWindow.cs            # ä¸Šä¸‹æ–‡çª—å£
â”‚   â”‚   â”œâ”€â”€ Prompt/
â”‚   â”‚   â”‚   â”œâ”€â”€ PromptEngine.cs             # Prompt å¼•æ“
â”‚   â”‚   â”‚   â””â”€â”€ Templates/                   # Prompt æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ Indexing/
â”‚   â”‚   â”‚   â”œâ”€â”€ CodeIndexer.cs              # ä»£ç ç´¢å¼•å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ VectorStore.cs              # å‘é‡å­˜å‚¨
â”‚   â”‚   â”‚   â””â”€â”€ EmbeddingService.cs         # Embedding æœåŠ¡
â”‚   â”‚   â””â”€â”€ Terminal/
â”‚   â”‚       â”œâ”€â”€ TerminalService.cs          # ç»ˆç«¯æœåŠ¡
â”‚   â”‚       â””â”€â”€ CommandParser.cs            # å‘½ä»¤è§£æå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ AIAssistant.VSIX/                    # VS æ’ä»¶é¡¹ç›®
â”‚   â”‚   â”œâ”€â”€ AIAssistantPackage.cs           # æ’ä»¶å…¥å£
â”‚   â”‚   â”œâ”€â”€ source.extension.vsixmanifest   # æ’ä»¶æ¸…å•
â”‚   â”‚   â”œâ”€â”€ Completion/
â”‚   â”‚   â”‚   â”œâ”€â”€ AICompletionSource.cs       # ä»£ç è¡¥å…¨æº
â”‚   â”‚   â”‚   â””â”€â”€ AICompletionProvider.cs     # è¡¥å…¨æä¾›è€…
â”‚   â”‚   â”œâ”€â”€ ToolWindows/
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatToolWindow.cs           # å¯¹è¯çª—å£
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatToolWindowControl.xaml  # å¯¹è¯ç•Œé¢
â”‚   â”‚   â”‚   â””â”€â”€ ChatViewModel.cs            # è§†å›¾æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Commands/
â”‚   â”‚   â”‚   â”œâ”€â”€ ExplainCodeCommand.cs       # è§£é‡Šä»£ç å‘½ä»¤
â”‚   â”‚   â”‚   â”œâ”€â”€ GenerateTestCommand.cs      # ç”Ÿæˆæµ‹è¯•å‘½ä»¤
â”‚   â”‚   â”‚   â””â”€â”€ RefactorCommand.cs          # é‡æ„å‘½ä»¤
â”‚   â”‚   â”œâ”€â”€ Settings/
â”‚   â”‚   â”‚   â”œâ”€â”€ SettingsPage.cs             # è®¾ç½®é¡µé¢
â”‚   â”‚   â”‚   â””â”€â”€ GeneralOptions.cs           # é€šç”¨é€‰é¡¹
â”‚   â”‚   â””â”€â”€ Resources/
â”‚   â”‚       â”œâ”€â”€ Icons/                       # å›¾æ ‡èµ„æº
â”‚   â”‚       â””â”€â”€ Styles/                      # æ ·å¼èµ„æº
â”‚   â”‚
â”‚   â””â”€â”€ AIAssistant.Tests/                   # å•å…ƒæµ‹è¯•
â”‚       â”œâ”€â”€ LLMClientTests.cs
â”‚       â”œâ”€â”€ ContextManagerTests.cs
â”‚       â””â”€â”€ PromptEngineTests.cs
â”‚
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ model-server/                        # æ¨¡å‹æœåŠ¡éƒ¨ç½²è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”‚   â”œâ”€â”€ vllm-config.yaml
â”‚   â”‚   â””â”€â”€ deploy.sh
â”‚   â””â”€â”€ embedding-server/                    # Embedding æœåŠ¡
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ VS2022_AI_Assistant_Solution.md      # æœ¬æ–‡æ¡£
â”‚   â”œâ”€â”€ API.md                               # API æ–‡æ¡£
â”‚   â”œâ”€â”€ Deployment.md                        # éƒ¨ç½²æ–‡æ¡£
â”‚   â””â”€â”€ UserGuide.md                         # ç”¨æˆ·æŒ‡å—
â”‚
â”œâ”€â”€ AIConsProject.sln                        # è§£å†³æ–¹æ¡ˆæ–‡ä»¶
â””â”€â”€ README.md
```

---

## 7. å¼€å‘è®¡åˆ’

### 7.1 é‡Œç¨‹ç¢‘è§„åˆ’

| é˜¶æ®µ | æ—¶é—´ | ç›®æ ‡ |
|------|------|------|
| **Phase 1: åŸºç¡€æ¡†æ¶** | 2-3 å‘¨ | æ’ä»¶æ¡†æ¶æ­å»ºã€LLM Clientã€åŸºç¡€ UI |
| **Phase 2: ä»£ç è¡¥å…¨** | 2-3 å‘¨ | ä¸Šä¸‹æ–‡æ”¶é›†ã€è¡¥å…¨æä¾›è€…ã€Inline æ˜¾ç¤º |
| **Phase 3: ä»£ç ç”Ÿæˆ** | 2-3 å‘¨ | å¯¹è¯çª—å£ã€å¤šè½®å¯¹è¯ã€ä»£ç æ’å…¥ |
| **Phase 4: é¡¹ç›®ç†è§£** | 3-4 å‘¨ | ä»£ç ç´¢å¼•ã€å‘é‡æœç´¢ã€æ™ºèƒ½é—®ç­” |
| **Phase 5: å‘½ä»¤æ‰§è¡Œ** | 2 å‘¨ | ç»ˆç«¯é›†æˆã€å‘½ä»¤ç”Ÿæˆã€å®‰å…¨æœºåˆ¶ |
| **Phase 6: ä¼˜åŒ–æµ‹è¯•** | 2-3 å‘¨ | æ€§èƒ½ä¼˜åŒ–ã€å…¨é¢æµ‹è¯•ã€æ–‡æ¡£å®Œå–„ |

### 7.2 è¯¦ç»†ä»»åŠ¡åˆ†è§£

#### Phase 1: åŸºç¡€æ¡†æ¶ (Week 1-3)
- [ ] åˆ›å»º VSIX é¡¹ç›®æ¨¡æ¿
- [ ] å®ç° LLM HTTP Client
- [ ] å®ç°æµå¼å“åº”å¤„ç†
- [ ] åˆ›å»ºåŸºç¡€ Tool Window
- [ ] å®ç°é…ç½®ç®¡ç†ç³»ç»Ÿ
- [ ] æ­å»ºæ—¥å¿—ç³»ç»Ÿ

#### Phase 2: ä»£ç è¡¥å…¨ (Week 4-6)
- [ ] å®ç° IAsyncCompletionSource
- [ ] å®ç°ä¸Šä¸‹æ–‡æ”¶é›†å™¨
- [ ] å®ç° FIM Prompt æ„å»º
- [ ] å®ç° Inline Completion UI
- [ ] å®ç° Tab/éƒ¨åˆ†æ¥å—é€»è¾‘
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆé˜²æŠ–ã€ç¼“å­˜ï¼‰

#### Phase 3: ä»£ç ç”Ÿæˆ (Week 7-9)
- [ ] å®ç°å¯¹è¯ç•Œé¢ (WPF)
- [ ] å®ç°å¤šè½®å¯¹è¯ç®¡ç†
- [ ] å®ç°ä»£ç é«˜äº®æ¸²æŸ“
- [ ] å®ç°ä»£ç æ’å…¥åŠŸèƒ½
- [ ] å®ç°å³é”®èœå•å‘½ä»¤
- [ ] å®ç°å¿«æ·é”®ç»‘å®š

#### Phase 4: é¡¹ç›®ç†è§£ (Week 10-13)
- [ ] å®ç° Roslyn ä»£ç åˆ†æ
- [ ] å®ç°ä»£ç å—åˆ†å‰²
- [ ] é›†æˆæœ¬åœ° Embedding æ¨¡å‹
- [ ] å®ç° SQLite å‘é‡å­˜å‚¨
- [ ] å®ç°è¯­ä¹‰æœç´¢
- [ ] å®ç°å¢é‡ç´¢å¼•æ›´æ–°

#### Phase 5: å‘½ä»¤æ‰§è¡Œ (Week 14-15)
- [ ] å®ç°ç»ˆç«¯è¿›ç¨‹ç®¡ç†
- [ ] å®ç°å‘½ä»¤ç”Ÿæˆé€»è¾‘
- [ ] å®ç°å®‰å…¨ç­–ç•¥å¼•æ“
- [ ] å®ç°æ‰§è¡Œç»“æœè§£æ
- [ ] å®ç°å†å²è®°å½•ç®¡ç†

#### Phase 6: ä¼˜åŒ–æµ‹è¯• (Week 16-18)
- [ ] æ€§èƒ½ Profiling ä¸ä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] é›†æˆæµ‹è¯•
- [ ] ç”¨æˆ·æ–‡æ¡£ç¼–å†™
- [ ] éƒ¨ç½²æ–‡æ¡£ç¼–å†™
- [ ] Bug ä¿®å¤ä¸ç¨³å®šæ€§æå‡

---

## 8. é…ç½®ä¸éƒ¨ç½²

### 8.1 æ’ä»¶é…ç½®é¡¹

```xml
<!-- ç”¨æˆ·é…ç½®ç¤ºä¾‹ -->
<AIAssistantSettings>
  <!-- LLM æœåŠ¡é…ç½® -->
  <LLM>
    <BaseUrl>http://192.168.1.100:8000</BaseUrl>
    <ApiKey>your-api-key</ApiKey>
    <ModelName>qwen3-coder-480b</ModelName>
    <Temperature>0.7</Temperature>
    <MaxTokens>4096</MaxTokens>
    <Timeout>60000</Timeout>
  </LLM>
  
  <!-- ä»£ç è¡¥å…¨é…ç½® -->
  <Completion>
    <Enabled>true</Enabled>
    <TriggerDelay>300</TriggerDelay>
    <MaxSuggestions>3</MaxSuggestions>
    <ContextLines>50</ContextLines>
  </Completion>
  
  <!-- é¡¹ç›®ç´¢å¼•é…ç½® -->
  <Indexing>
    <Enabled>true</Enabled>
    <AutoIndex>true</AutoIndex>
    <ExcludePatterns>bin,obj,node_modules,.git</ExcludePatterns>
    <IndexPath>.ai-index</IndexPath>
  </Indexing>
  
  <!-- ç»ˆç«¯é…ç½® -->
  <Terminal>
    <AutoExecuteWhitelist>dotnet build,dotnet test,git status</AutoExecuteWhitelist>
    <ConfirmBeforeExecute>true</ConfirmBeforeExecute>
  </Terminal>
</AIAssistantSettings>
```

### 8.2 æ¨¡å‹æœåŠ¡éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  vllm:
    image: vllm/vllm-openai:latest
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - /data/models:/models
    command: >
      --model /models/Qwen3-Coder-480B-A35B-Instruct
      --tensor-parallel-size 8
      --max-model-len 32768
      --gpu-memory-utilization 0.95
      --host 0.0.0.0
      --port 8000
    ports:
      - "8000:8000"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 8
              capabilities: [gpu]

  nginx:
    image: nginx:latest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
    depends_on:
      - vllm
```

---

## 9. å®‰å…¨ä¸éšç§

### 9.1 ç½‘ç»œéš”ç¦»

```
å®‰å…¨ç­–ç•¥:
â”œâ”€â”€ å®Œå…¨å†…ç½‘è¿è¡Œ
â”‚   â”œâ”€â”€ æ’ä»¶ä¸è¿æ¥ä»»ä½•å¤–éƒ¨æœåŠ¡
â”‚   â”œâ”€â”€ LLM æœåŠ¡éƒ¨ç½²åœ¨å†…ç½‘
â”‚   â””â”€â”€ æ‰€æœ‰é€šä¿¡ä½¿ç”¨å†…ç½‘ IP/åŸŸå
â”œâ”€â”€ é˜²ç«å¢™è§„åˆ™
â”‚   â”œâ”€â”€ æ’ä»¶è¿›ç¨‹ç¦æ­¢å¤–ç½‘è®¿é—®
â”‚   â””â”€â”€ åªå…è®¸è®¿é—®é…ç½®çš„ LLM æœåŠ¡åœ°å€
â””â”€â”€ ä»£ç†æ£€æµ‹
    â””â”€â”€ æ£€æµ‹å¹¶ç¦ç”¨ç³»ç»Ÿä»£ç†
```

### 9.2 æ•°æ®å®‰å…¨

- **ä»£ç ä¸å‡ºå†…ç½‘**: æ‰€æœ‰ä»£ç æ•°æ®åªåœ¨æœ¬åœ°å’Œå†…ç½‘ LLM æœåŠ¡é—´ä¼ è¾“
- **æœ¬åœ°å­˜å‚¨åŠ å¯†**: æ•æ„Ÿé…ç½®ï¼ˆAPI Keyï¼‰åŠ å¯†å­˜å‚¨
- **æ—¥å¿—è„±æ•**: æ—¥å¿—ä¸­ä¸è®°å½•å®Œæ•´ä»£ç å†…å®¹
- **æƒé™æ§åˆ¶**: æ”¯æŒ API Key è®¤è¯å’Œæƒé™åˆ†çº§

---

## 10. æ€§èƒ½ä¼˜åŒ–

### 10.1 å®¢æˆ·ç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | ç­–ç•¥ |
|--------|------|
| **è¯·æ±‚é˜²æŠ–** | ç”¨æˆ·åœæ­¢è¾“å…¥ 300ms åæ‰è§¦å‘è¡¥å…¨è¯·æ±‚ |
| **è¯·æ±‚ç¼“å­˜** | ç›¸åŒä¸Šä¸‹æ–‡çš„è¡¥å…¨ç»“æœç¼“å­˜ 5 åˆ†é’Ÿ |
| **å¼‚æ­¥åŠ è½½** | UI ä¸é˜»å¡ï¼Œä½¿ç”¨ async/await |
| **å¢é‡ç´¢å¼•** | åªç´¢å¼•å˜æ›´çš„æ–‡ä»¶ |
| **è¿æ¥æ± ** | HTTP è¿æ¥å¤ç”¨ |

### 10.2 æœåŠ¡ç«¯ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | ç­–ç•¥ |
|--------|------|
| **KV Cache** | å¯ç”¨ vLLM çš„ KV ç¼“å­˜ |
| **æ‰¹å¤„ç†** | å¤šè¯·æ±‚åˆå¹¶æ¨ç† |
| **é‡åŒ–** | ä½¿ç”¨ INT8/INT4 é‡åŒ–å‡å°‘æ˜¾å­˜ |
| **è´Ÿè½½å‡è¡¡** | å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼éƒ¨ç½² |

---

## 11. æ‰©å±•æ€§è®¾è®¡

### 11.1 æ’ä»¶æ‰©å±•ç‚¹

```csharp
// æ”¯æŒè‡ªå®šä¹‰ Prompt æä¾›è€…
public interface IPromptProvider
{
    string GetSystemPrompt(PromptContext context);
    string BuildUserPrompt(PromptContext context);
}

// æ”¯æŒè‡ªå®šä¹‰ä¸Šä¸‹æ–‡æ”¶é›†å™¨
public interface IContextCollector
{
    Task<CodeContext> CollectAsync(ITextView textView);
}

// æ”¯æŒè‡ªå®šä¹‰å‘½ä»¤å¤„ç†å™¨
public interface ICommandHandler
{
    bool CanHandle(string command);
    Task<CommandResult> ExecuteAsync(string command);
}
```

### 11.2 å¤šæ¨¡å‹æ”¯æŒ

é…ç½®æ–‡ä»¶æ”¯æŒå¤šæ¨¡å‹åˆ‡æ¢ï¼š

```json
{
  "models": [
    {
      "name": "qwen3-coder-480b",
      "endpoint": "http://192.168.1.100:8000",
      "useFor": ["completion", "generation"]
    },
    {
      "name": "qwen3-coder-32b",
      "endpoint": "http://192.168.1.101:8000",
      "useFor": ["chat", "explanation"]
    }
  ]
}
```

---

## 12. Agent æ¶æ„è®¾è®¡ï¼ˆæ ¸å¿ƒï¼‰

> æœ¬ç« èŠ‚å‚è€ƒç°ä»£ AI IDEï¼ˆå¦‚ Cursorã€Windsurf/Cascadeã€Clineï¼‰çš„ Agent æ¶æ„è®¾è®¡ï¼Œæ˜¯å®ç°å¼ºå¤§ AI è¾…åŠ©ç¼–ç¨‹èƒ½åŠ›çš„æ ¸å¿ƒã€‚

### 12.1 Agent æ ¸å¿ƒç†å¿µ

**ä¼ ç»Ÿ AI åŠ©æ‰‹ vs Agent AI åŠ©æ‰‹**ï¼š

| ç»´åº¦ | ä¼ ç»Ÿ AI åŠ©æ‰‹ | Agent AI åŠ©æ‰‹ |
|------|-------------|---------------|
| **äº¤äº’æ¨¡å¼** | å•è½®é—®ç­” | å¤šæ­¥éª¤è‡ªä¸»æ‰§è¡Œ |
| **èƒ½åŠ›è¾¹ç•Œ** | ä»…ç”Ÿæˆæ–‡æœ¬ | å¯è°ƒç”¨å·¥å…·ã€æ‰§è¡Œæ“ä½œ |
| **ä¸Šä¸‹æ–‡** | ä»…å¯¹è¯å†å² | ä»£ç åº“ + æ–‡ä»¶ç³»ç»Ÿ + ç»ˆç«¯ |
| **æ‰§è¡Œæ–¹å¼** | ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶ç²˜è´´ | ç›´æ¥ä¿®æ”¹æ–‡ä»¶ã€è¿è¡Œå‘½ä»¤ |
| **ä»»åŠ¡è§„åˆ’** | æ—  | è‡ªåŠ¨åˆ†è§£ä»»åŠ¡ã€åˆ¶å®šè®¡åˆ’ |

### 12.2 Tool Calling æ¶æ„

Agent çš„æ ¸å¿ƒèƒ½åŠ›æ¥è‡ª **Tool Callingï¼ˆå·¥å…·è°ƒç”¨ï¼‰** æœºåˆ¶ï¼š

```
Agent æ‰§è¡Œå¾ªç¯:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent Loop                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    ç”¨æˆ·è¯·æ±‚                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              LLM åˆ†æ + å†³ç­–                            â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ 1. ç†è§£ç”¨æˆ·æ„å›¾                                  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ 2. åˆ†æå½“å‰ä¸Šä¸‹æ–‡                                â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ 3. å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆè°ƒç”¨å“ªä¸ªå·¥å…·ï¼‰                â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ 4. ç”Ÿæˆå·¥å…·è°ƒç”¨å‚æ•°                              â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Tool Dispatcherï¼ˆå·¥å…·åˆ†å‘å™¨ï¼‰              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  â”‚ è¯»æ–‡ä»¶  â”‚ â”‚ ç¼–è¾‘   â”‚ â”‚ æœç´¢   â”‚ â”‚ ç»ˆç«¯   â”‚ ...      â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              å·¥å…·æ‰§è¡Œç»“æœ                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         ç»“æœåé¦ˆç»™ LLMï¼Œç»§ç»­ä¸‹ä¸€è½®å†³ç­–                  â”‚    â”‚
â”‚  â”‚         ï¼ˆå¾ªç¯ç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.3 æ ¸å¿ƒå·¥å…·é›†å®šä¹‰

å‚è€ƒ Cascade/Cline çš„å·¥å…·è®¾è®¡ï¼Œå®šä¹‰ä»¥ä¸‹æ ¸å¿ƒå·¥å…·ï¼š

#### 12.3.1 ä»£ç æœç´¢å·¥å…·

```csharp
public class ToolDefinitions
{
    // 1. è¯­ä¹‰ä»£ç æœç´¢ - åŸºäºè‡ªç„¶è¯­è¨€æœç´¢ä»£ç 
    public static Tool CodeSearch => new Tool
    {
        Name = "code_search",
        Description = "åŸºäºè‡ªç„¶è¯­è¨€è¯­ä¹‰æœç´¢ä»£ç åº“ï¼Œæ‰¾åˆ°ç›¸å…³çš„ä»£ç ç‰‡æ®µã€å‡½æ•°ã€ç±»",
        Parameters = new
        {
            search_term = "æœç´¢æŸ¥è¯¢ï¼Œå¦‚'ç”¨æˆ·è®¤è¯çš„å¤„ç†é€»è¾‘'",
            search_folder = "æœç´¢çš„ç›®å½•è·¯å¾„"
        }
    };

    // 2. ç²¾ç¡®æ–‡æœ¬æœç´¢ - grep é£æ ¼æœç´¢
    public static Tool GrepSearch => new Tool
    {
        Name = "grep_search",
        Description = "åœ¨ä»£ç åº“ä¸­ç²¾ç¡®æœç´¢æ–‡æœ¬æˆ–æ­£åˆ™è¡¨è¾¾å¼",
        Parameters = new
        {
            query = "æœç´¢çš„æ–‡æœ¬æˆ–æ­£åˆ™è¡¨è¾¾å¼",
            search_path = "æœç´¢è·¯å¾„",
            includes = "æ–‡ä»¶è¿‡æ»¤ glob æ¨¡å¼ï¼Œå¦‚ *.cs",
            case_sensitive = "æ˜¯å¦å¤§å°å†™æ•æ„Ÿ"
        }
    };

    // 3. æ–‡ä»¶åæœç´¢
    public static Tool FindByName => new Tool
    {
        Name = "find_by_name",
        Description = "æŒ‰æ–‡ä»¶åæˆ–ç›®å½•åæœç´¢",
        Parameters = new
        {
            pattern = "æ–‡ä»¶å glob æ¨¡å¼",
            search_directory = "æœç´¢ç›®å½•",
            type = "file æˆ– directory"
        }
    };
}
```

#### 12.3.2 æ–‡ä»¶æ“ä½œå·¥å…·

```csharp
// 4. è¯»å–æ–‡ä»¶
public static Tool ReadFile => new Tool
{
    Name = "read_file",
    Description = "è¯»å–æŒ‡å®šæ–‡ä»¶çš„å†…å®¹ï¼Œæ”¯æŒæŒ‡å®šè¡ŒèŒƒå›´",
    Parameters = new
    {
        file_path = "æ–‡ä»¶ç»å¯¹è·¯å¾„",
        offset = "èµ·å§‹è¡Œå·ï¼ˆå¯é€‰ï¼‰",
        limit = "è¯»å–è¡Œæ•°ï¼ˆå¯é€‰ï¼‰"
    }
};

// 5. ç²¾ç¡®ç¼–è¾‘ - å·®å¼‚åŒ–ä¿®æ”¹ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
public static Tool Edit => new Tool
{
    Name = "edit",
    Description = "å¯¹æ–‡ä»¶è¿›è¡Œç²¾ç¡®çš„æŸ¥æ‰¾æ›¿æ¢ç¼–è¾‘ï¼Œåªä¿®æ”¹éœ€è¦æ”¹åŠ¨çš„éƒ¨åˆ†",
    Parameters = new
    {
        file_path = "æ–‡ä»¶è·¯å¾„",
        old_string = "è¦æ›¿æ¢çš„åŸå§‹æ–‡æœ¬ï¼ˆå¿…é¡»å”¯ä¸€åŒ¹é…ï¼‰",
        new_string = "æ›¿æ¢åçš„æ–°æ–‡æœ¬",
        explanation = "ä¿®æ”¹è¯´æ˜"
    }
};

// 6. å¤šå¤„ç¼–è¾‘ - æ‰¹é‡ä¿®æ”¹
public static Tool MultiEdit => new Tool
{
    Name = "multi_edit",
    Description = "åœ¨åŒä¸€æ–‡ä»¶ä¸­è¿›è¡Œå¤šå¤„ç¼–è¾‘",
    Parameters = new
    {
        file_path = "æ–‡ä»¶è·¯å¾„",
        edits = new[] {
            new { old_string = "åŸæ–‡æœ¬1", new_string = "æ–°æ–‡æœ¬1" },
            new { old_string = "åŸæ–‡æœ¬2", new_string = "æ–°æ–‡æœ¬2" }
        }
    }
};

// 7. åˆ›å»ºæ–°æ–‡ä»¶
public static Tool WriteToFile => new Tool
{
    Name = "write_to_file",
    Description = "åˆ›å»ºæ–°æ–‡ä»¶å¹¶å†™å…¥å†…å®¹",
    Parameters = new
    {
        target_file = "ç›®æ ‡æ–‡ä»¶è·¯å¾„",
        code_content = "æ–‡ä»¶å†…å®¹"
    }
};
```

#### 12.3.3 å‘½ä»¤æ‰§è¡Œå·¥å…·

```csharp
// 8. æ‰§è¡Œç»ˆç«¯å‘½ä»¤
public static Tool RunCommand => new Tool
{
    Name = "run_command",
    Description = "åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œå‘½ä»¤",
    Parameters = new
    {
        command_line = "è¦æ‰§è¡Œçš„å‘½ä»¤",
        cwd = "å·¥ä½œç›®å½•",
        blocking = "æ˜¯å¦é˜»å¡ç­‰å¾…å®Œæˆ",
        safe_to_auto_run = "æ˜¯å¦å¯ä»¥è‡ªåŠ¨æ‰§è¡Œï¼ˆå®‰å…¨å‘½ä»¤ï¼‰"
    }
};

// 9. æ£€æŸ¥å‘½ä»¤çŠ¶æ€
public static Tool CommandStatus => new Tool
{
    Name = "command_status",
    Description = "æ£€æŸ¥åå°å‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€å’Œè¾“å‡º",
    Parameters = new
    {
        command_id = "å‘½ä»¤ID",
        wait_duration_seconds = "ç­‰å¾…æ—¶é—´"
    }
};
```

#### 12.3.4 ä»»åŠ¡ç®¡ç†å·¥å…·

```csharp
// 10. ä»»åŠ¡è®¡åˆ’ç®¡ç†
public static Tool UpdatePlan => new Tool
{
    Name = "update_plan",
    Description = "åˆ›å»ºæˆ–æ›´æ–°ä»»åŠ¡æ‰§è¡Œè®¡åˆ’",
    Parameters = new
    {
        plan = new[] {
            new { step = "æ­¥éª¤æè¿°", status = "pending|in_progress|completed" }
        }
    }
};

// 11. è®°å¿†å­˜å‚¨
public static Tool CreateMemory => new Tool
{
    Name = "create_memory",
    Description = "ä¿å­˜é‡è¦ä¿¡æ¯åˆ°æŒä¹…åŒ–è®°å¿†åº“",
    Parameters = new
    {
        title = "è®°å¿†æ ‡é¢˜",
        content = "è®°å¿†å†…å®¹",
        tags = "æ ‡ç­¾åˆ—è¡¨"
    }
};
```

### 12.4 å·®å¼‚åŒ–ç¼–è¾‘ï¼ˆDiff-based Editï¼‰

**è¿™æ˜¯ Agent èƒ½åŠ›çš„å…³é”®è®¾è®¡**ï¼šä¸å…¨é‡æ›¿æ¢æ–‡ä»¶ï¼Œè€Œæ˜¯ç²¾ç¡®ä¿®æ”¹ã€‚

```
ä¼ ç»Ÿæ–¹å¼ vs å·®å¼‚åŒ–ç¼–è¾‘:

âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆå…¨é‡æ›¿æ¢ï¼‰ï¼š
   1. è¯»å–æ•´ä¸ªæ–‡ä»¶
   2. LLM ç”Ÿæˆæ•´ä¸ªæ–°æ–‡ä»¶
   3. è¦†ç›–å†™å…¥
   é—®é¢˜ï¼šToken æ¶ˆè€—å¤§ã€å®¹æ˜“å‡ºé”™ã€ä¸¢å¤±æ— å…³ä»£ç 

âœ… å·®å¼‚åŒ–ç¼–è¾‘ï¼ˆæ¨èï¼‰ï¼š
   1. è¯»å–æ–‡ä»¶ï¼ˆæˆ–ç›¸å…³éƒ¨åˆ†ï¼‰
   2. LLM åªç”Ÿæˆéœ€è¦ä¿®æ”¹çš„ç‰‡æ®µ
   3. ç²¾ç¡®æ›¿æ¢æŒ‡å®šä½ç½®
   ä¼˜åŠ¿ï¼šToken é«˜æ•ˆã€ç²¾ç¡®å¯æ§ã€ä¸å½±å“å…¶ä»–ä»£ç 
```

**å®ç°ç¤ºä¾‹**ï¼š

```csharp
public class DiffEditor
{
    public async Task<EditResult> ApplyEditAsync(EditRequest request)
    {
        // 1. è¯»å–åŸæ–‡ä»¶
        var content = await File.ReadAllTextAsync(request.FilePath);
        
        // 2. æŸ¥æ‰¾ old_stringï¼ˆå¿…é¡»å”¯ä¸€åŒ¹é…ï¼‰
        var index = content.IndexOf(request.OldString);
        if (index == -1)
            return EditResult.Fail("æœªæ‰¾åˆ°åŒ¹é…çš„ä»£ç ç‰‡æ®µ");
        
        var lastIndex = content.LastIndexOf(request.OldString);
        if (index != lastIndex)
            return EditResult.Fail("åŒ¹é…ä¸å”¯ä¸€ï¼Œè¯·æä¾›æ›´å¤šä¸Šä¸‹æ–‡");
        
        // 3. æ‰§è¡Œæ›¿æ¢
        var newContent = content.Substring(0, index) 
                       + request.NewString 
                       + content.Substring(index + request.OldString.Length);
        
        // 4. å†™å›æ–‡ä»¶
        await File.WriteAllTextAsync(request.FilePath, newContent);
        
        return EditResult.Success();
    }
}
```

### 12.5 ä¸Šä¸‹æ–‡æ”¶é›†ç­–ç•¥

Agent éœ€è¦æ™ºèƒ½æ”¶é›†ç›¸å…³ä¸Šä¸‹æ–‡ï¼Œè€Œéç›²ç›®è¯»å–æ‰€æœ‰æ–‡ä»¶ï¼š

```
ä¸Šä¸‹æ–‡æ”¶é›†ç­–ç•¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ™ºèƒ½ä¸Šä¸‹æ–‡æ”¶é›†                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. å½“å‰ç„¦ç‚¹æ–‡ä»¶                                                 â”‚
â”‚     â”œâ”€â”€ å½“å‰æ‰“å¼€çš„æ–‡ä»¶å®Œæ•´å†…å®¹                                   â”‚
â”‚     â””â”€â”€ å…‰æ ‡ä½ç½®å‘¨å›´çš„ä»£ç                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. ç›¸å…³æ–‡ä»¶ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰                                         â”‚
â”‚     â”œâ”€â”€ å¯¼å…¥/å¼•ç”¨çš„æ–‡ä»¶                                          â”‚
â”‚     â”œâ”€â”€ åŒç›®å½•ç›¸å…³æ–‡ä»¶                                           â”‚
â”‚     â”œâ”€â”€ è¯­ä¹‰æœç´¢å‘½ä¸­çš„æ–‡ä»¶                                       â”‚
â”‚     â””â”€â”€ æœ€è¿‘ç¼–è¾‘çš„æ–‡ä»¶                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. é¡¹ç›®å…ƒä¿¡æ¯                                                   â”‚
â”‚     â”œâ”€â”€ é¡¹ç›®é…ç½® (.csproj, package.json)                        â”‚
â”‚     â”œâ”€â”€ ç›®å½•ç»“æ„æ¦‚è§ˆ                                             â”‚
â”‚     â””â”€â”€ Git çŠ¶æ€å’Œå†å²                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. è¿è¡Œæ—¶ä¿¡æ¯                                                   â”‚
â”‚     â”œâ”€â”€ ç¼–è¯‘é”™è¯¯/è­¦å‘Š                                            â”‚
â”‚     â”œâ”€â”€ ç»ˆç«¯è¾“å‡º                                                 â”‚
â”‚     â””â”€â”€ æµ‹è¯•ç»“æœ                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸Šä¸‹æ–‡çª—å£ç®¡ç†**ï¼š

```csharp
public class ContextManager
{
    private const int MaxContextTokens = 100000; // æ ¹æ®æ¨¡å‹è°ƒæ•´
    
    public async Task<AgentContext> BuildContextAsync(UserRequest request)
    {
        var context = new AgentContext();
        var tokenBudget = MaxContextTokens;
        
        // 1. ä¼˜å…ˆçº§æœ€é«˜ï¼šå½“å‰æ–‡ä»¶
        if (request.CurrentFile != null)
        {
            var content = await ReadFileAsync(request.CurrentFile);
            context.AddWithPriority(content, Priority.Highest);
            tokenBudget -= EstimateTokens(content);
        }
        
        // 2. è¯­ä¹‰æœç´¢ç›¸å…³ä»£ç 
        var searchResults = await _codeSearch.SearchAsync(request.Query);
        foreach (var result in searchResults.Take(10))
        {
            if (tokenBudget <= 0) break;
            context.AddWithPriority(result.Content, Priority.High);
            tokenBudget -= EstimateTokens(result.Content);
        }
        
        // 3. å¼•ç”¨çš„ç¬¦å·å®šä¹‰
        var symbols = await _roslynAnalyzer.GetReferencedSymbolsAsync(request.CurrentFile);
        foreach (var symbol in symbols)
        {
            if (tokenBudget <= 0) break;
            context.AddWithPriority(symbol.Definition, Priority.Medium);
            tokenBudget -= EstimateTokens(symbol.Definition);
        }
        
        // 4. é¡¹ç›®ç»“æ„ï¼ˆå‹ç¼©æ ¼å¼ï¼‰
        var projectStructure = await GetProjectStructureAsync();
        context.AddWithPriority(projectStructure, Priority.Low);
        
        return context;
    }
}
```

### 12.6 å¤šæ­¥éª¤ä»»åŠ¡è§„åˆ’

Agent èƒ½å¤Ÿè‡ªåŠ¨åˆ†è§£å¤æ‚ä»»åŠ¡å¹¶é€æ­¥æ‰§è¡Œï¼š

```
ä»»åŠ¡è§„åˆ’ç¤ºä¾‹:

ç”¨æˆ·è¯·æ±‚: "å¸®æˆ‘å®ç°ä¸€ä¸ªç”¨æˆ·ç™»å½•åŠŸèƒ½ï¼ŒåŒ…å«å‰ç«¯è¡¨å•å’Œåç«¯API"

Agent è‡ªåŠ¨è§„åˆ’:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰§è¡Œè®¡åˆ’:                                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â–¡ 1. åˆ†æç°æœ‰é¡¹ç›®ç»“æ„å’ŒæŠ€æœ¯æ ˆ                               â”‚ â”‚
â”‚ â”‚ â–¡ 2. åˆ›å»º LoginController.cs åç«¯ API                       â”‚ â”‚
â”‚ â”‚ â–¡ 3. åˆ›å»º UserService.cs ä¸šåŠ¡é€»è¾‘                           â”‚ â”‚
â”‚ â”‚ â–¡ 4. åˆ›å»º Login.razor å‰ç«¯ç»„ä»¶                              â”‚ â”‚
â”‚ â”‚ â–¡ 5. æ·»åŠ è·¯ç”±é…ç½®                                           â”‚ â”‚
â”‚ â”‚ â–¡ 6. ç¼–å†™å•å…ƒæµ‹è¯•                                           â”‚ â”‚
â”‚ â”‚ â–¡ 7. è¿è¡Œæµ‹è¯•éªŒè¯                                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚ å½“å‰æ‰§è¡Œ: [æ­¥éª¤ 1 - åˆ†æé¡¹ç›®ç»“æ„]                                â”‚
â”‚ å·¥å…·è°ƒç”¨: find_by_name, read_file, code_search                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 12.7 Agent å¾ªç¯å®ç°

```csharp
public class AgentExecutor
{
    private readonly ILLMClient _llm;
    private readonly IToolDispatcher _tools;
    private readonly IContextManager _context;
    
    public async IAsyncEnumerable<AgentStep> ExecuteAsync(
        string userRequest,
        CancellationToken cancellationToken)
    {
        var messages = new List<ChatMessage>
        {
            new SystemMessage(GetSystemPrompt()),
            new UserMessage(userRequest)
        };
        
        var context = await _context.BuildContextAsync(userRequest);
        messages.Add(new SystemMessage($"å½“å‰ä¸Šä¸‹æ–‡:\n{context}"));
        
        var maxIterations = 50; // é˜²æ­¢æ— é™å¾ªç¯
        var iteration = 0;
        
        while (iteration++ < maxIterations)
        {
            // 1. è°ƒç”¨ LLM è·å–ä¸‹ä¸€æ­¥è¡ŒåŠ¨
            var response = await _llm.ChatWithToolsAsync(
                messages, 
                GetToolDefinitions(),
                cancellationToken);
            
            // 2. å¦‚æœæ˜¯æ™®é€šæ–‡æœ¬å›å¤ï¼Œè¯´æ˜ä»»åŠ¡å®Œæˆ
            if (!response.HasToolCalls)
            {
                yield return new AgentStep
                {
                    Type = StepType.FinalResponse,
                    Content = response.Content
                };
                yield break;
            }
            
            // 3. æ‰§è¡Œå·¥å…·è°ƒç”¨
            foreach (var toolCall in response.ToolCalls)
            {
                yield return new AgentStep
                {
                    Type = StepType.ToolCall,
                    ToolName = toolCall.Name,
                    Parameters = toolCall.Parameters
                };
                
                // æ‰§è¡Œå·¥å…·
                var result = await _tools.ExecuteAsync(toolCall);
                
                yield return new AgentStep
                {
                    Type = StepType.ToolResult,
                    Content = result.Output
                };
                
                // å°†ç»“æœåŠ å…¥å¯¹è¯å†å²
                messages.Add(new ToolResultMessage(toolCall.Id, result.Output));
            }
            
            // æ·»åŠ åŠ©æ‰‹æ¶ˆæ¯åˆ°å†å²
            messages.Add(response.ToAssistantMessage());
        }
        
        yield return new AgentStep
        {
            Type = StepType.Error,
            Content = "è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œä»»åŠ¡æœªå®Œæˆ"
        };
    }
}
```

### 12.8 å®‰å…¨æ‰§è¡Œæœºåˆ¶

Agent éœ€è¦ä¸¥æ ¼çš„å®‰å…¨æ§åˆ¶ï¼š

```csharp
public class SafetyGuard
{
    // å‘½ä»¤å®‰å…¨åˆ†ç±»
    public CommandSafety ClassifyCommand(string command)
    {
        // ç™½åå• - å¯è‡ªåŠ¨æ‰§è¡Œ
        var safeCommands = new[] { 
            "dotnet build", "dotnet test", "git status", 
            "git log", "git diff", "dir", "ls", "cat", "type"
        };
        if (safeCommands.Any(c => command.StartsWith(c)))
            return CommandSafety.Safe;
        
        // é»‘åå• - ç¦æ­¢æ‰§è¡Œ
        var dangerousPatterns = new[] {
            "rm -rf", "del /s", "format", "curl", "wget",
            "Invoke-WebRequest", "ssh", "scp"
        };
        if (dangerousPatterns.Any(p => command.Contains(p)))
            return CommandSafety.Forbidden;
        
        // å…¶ä»– - éœ€è¦ç”¨æˆ·ç¡®è®¤
        return CommandSafety.RequiresConfirmation;
    }
    
    // æ–‡ä»¶ç¼–è¾‘å®‰å…¨æ£€æŸ¥
    public bool CanEditFile(string filePath)
    {
        // ç¦æ­¢ç¼–è¾‘çš„è·¯å¾„
        var protectedPaths = new[] {
            ".git", "node_modules", "bin", "obj",
            "*.exe", "*.dll", "*.pdb"
        };
        return !protectedPaths.Any(p => 
            filePath.Contains(p) || 
            Glob.IsMatch(filePath, p));
    }
}
```

### 12.9 å¹¶è¡Œå·¥å…·è°ƒç”¨

æå‡æ•ˆç‡çš„å…³é”®ï¼šå½“å¤šä¸ªå·¥å…·è°ƒç”¨ç›¸äº’ç‹¬ç«‹æ—¶ï¼Œå¹¶è¡Œæ‰§è¡Œã€‚

```csharp
public class ParallelToolExecutor
{
    public async Task<List<ToolResult>> ExecuteParallelAsync(
        List<ToolCall> toolCalls,
        CancellationToken cancellationToken)
    {
        // åˆ†æä¾èµ–å…³ç³»
        var independentCalls = toolCalls
            .Where(t => !HasDependency(t, toolCalls))
            .ToList();
        
        // å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹çš„å·¥å…·è°ƒç”¨
        var tasks = independentCalls
            .Select(t => ExecuteSingleAsync(t, cancellationToken));
        
        var results = await Task.WhenAll(tasks);
        return results.ToList();
    }
    
    private bool HasDependency(ToolCall call, List<ToolCall> allCalls)
    {
        // ä¾‹å¦‚ï¼šedit ä¾èµ–äº read_file çš„ç»“æœ
        // å®ç°ä¾èµ–åˆ†æé€»è¾‘
        return false;
    }
}
```

### 12.10 å·¥å…·è°ƒç”¨çš„ Prompt å·¥ç¨‹

è®© LLM æ­£ç¡®è°ƒç”¨å·¥å…·çš„ System Prompt è®¾è®¡ï¼š

```
# AI ç¼–ç¨‹åŠ©æ‰‹ System Prompt

ä½ æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ AI ç¼–ç¨‹åŠ©æ‰‹ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨å·¥å…·æ¥å®Œæˆç¼–ç¨‹ä»»åŠ¡ã€‚

## å¯ç”¨å·¥å…·

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š
- `code_search`: è¯­ä¹‰æœç´¢ä»£ç åº“
- `grep_search`: ç²¾ç¡®æ–‡æœ¬æœç´¢
- `find_by_name`: æ–‡ä»¶åæœç´¢
- `read_file`: è¯»å–æ–‡ä»¶å†…å®¹
- `edit`: ç²¾ç¡®ç¼–è¾‘æ–‡ä»¶ï¼ˆæŸ¥æ‰¾æ›¿æ¢ï¼‰
- `write_to_file`: åˆ›å»ºæ–°æ–‡ä»¶
- `run_command`: æ‰§è¡Œç»ˆç«¯å‘½ä»¤
- `update_plan`: ç®¡ç†ä»»åŠ¡è®¡åˆ’

## å·¥ä½œåŸåˆ™

1. **å…ˆç†è§£å†è¡ŒåŠ¨**: åœ¨ä¿®æ”¹ä»£ç å‰ï¼Œå…ˆç”¨æœç´¢å·¥å…·äº†è§£ä»£ç ç»“æ„
2. **ç²¾ç¡®ç¼–è¾‘**: ä½¿ç”¨ edit å·¥å…·è¿›è¡Œæœ€å°åŒ–ä¿®æ”¹ï¼Œä¸è¦é‡å†™æ•´ä¸ªæ–‡ä»¶
3. **é€æ­¥æ‰§è¡Œ**: å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œæ¯æ­¥éªŒè¯åå†ç»§ç»­
4. **å®‰å…¨ç¬¬ä¸€**: å±é™©å‘½ä»¤å¿…é¡»è®©ç”¨æˆ·ç¡®è®¤
5. **ä¿æŒä»£ç é£æ ¼**: éµå¾ªé¡¹ç›®ç°æœ‰çš„ä»£ç é£æ ¼å’Œçº¦å®š

## å·¥å…·è°ƒç”¨æ ¼å¼

å½“éœ€è¦è°ƒç”¨å·¥å…·æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹ JSON æ ¼å¼ï¼š
{
    "tool": "å·¥å…·åç§°",
    "parameters": {
        "å‚æ•°å": "å‚æ•°å€¼"
    }
}

## æ³¨æ„äº‹é¡¹

- ä¸€æ¬¡å¯ä»¥è°ƒç”¨å¤šä¸ªç‹¬ç«‹çš„å·¥å…·ï¼ˆå¹¶è¡Œï¼‰
- è¯»å–æ–‡ä»¶åæ‰èƒ½ç¼–è¾‘
- edit çš„ old_string å¿…é¡»åœ¨æ–‡ä»¶ä¸­å”¯ä¸€å­˜åœ¨
- å‘½ä»¤æ‰§è¡Œç»“æœè¦åˆ†æï¼Œæ ¹æ®ç»“æœå†³å®šä¸‹ä¸€æ­¥
```

---

## 13. é™„å½•

### 13.1 å‚è€ƒèµ„æº

- [Visual Studio Extensibility Documentation](https://docs.microsoft.com/en-us/visualstudio/extensibility/)
- [Roslyn (Microsoft.CodeAnalysis)](https://github.com/dotnet/roslyn)
- [vLLM Documentation](https://docs.vllm.ai/)
- [Qwen3-Coder Model](https://www.modelscope.cn/models/Qwen/Qwen3-Coder-480B-A35B-Instruct)

### 13.2 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| **VSIX** | Visual Studio Extension çš„å®‰è£…åŒ…æ ¼å¼ |
| **Roslyn** | .NET ç¼–è¯‘å™¨å¹³å°ï¼Œæä¾›ä»£ç åˆ†æ API |
| **FIM** | Fill-in-the-Middleï¼Œä»£ç è¡¥å…¨çš„ Prompt æ ¼å¼ |
| **vLLM** | é«˜æ€§èƒ½ LLM æ¨ç†å¼•æ“ |
| **MoE** | Mixture of Expertsï¼Œæ··åˆä¸“å®¶æ¨¡å‹æ¶æ„ |
| **SSE** | Server-Sent Eventsï¼ŒæœåŠ¡ç«¯æ¨é€æŠ€æœ¯ |
| **Agent** | å…·å¤‡å·¥å…·è°ƒç”¨èƒ½åŠ›çš„è‡ªä¸» AI åŠ©æ‰‹ |
| **Tool Calling** | LLM è°ƒç”¨å¤–éƒ¨å·¥å…·çš„æœºåˆ¶ |
| **Diff-based Edit** | å·®å¼‚åŒ–ç¼–è¾‘ï¼Œç²¾ç¡®ä¿®æ”¹ä»£ç ç‰‡æ®µ |

### 13.3 ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | è¯´æ˜ |
|------|------|------|
| v0.1 | 2026-02-04 | åˆå§‹è§£å†³æ–¹æ¡ˆæ–‡æ¡£ |
| v0.2 | 2026-02-04 | æ–°å¢ Agent æ¶æ„è®¾è®¡ç« èŠ‚ï¼Œå‚è€ƒ Cascade/Cline èƒ½åŠ› |

---

**æ–‡æ¡£ç»´æŠ¤**: AI Assistant å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-02-04
